{% extends 'home/base.html' %}
{% load static %}

{% comment %} CSS {% endcomment %}
{% block styling %}
    <link rel="stylesheet" href="{% static 'css/gallery.css' %}">
{% endblock styling %}


{% comment %} BODY {% endcomment %}
{% block content %}
    <div class="gallery-container" style="background: url('{% static "images/bg.jpg" %}') no-repeat center center/cover; padding-top: 6rem; padding-bottom: 4rem;">
        <h1>Explore Beautiful <span class="yellow-gradient-text">Destinations . . .</span</h1>
        <div class="search-container" style="color:black;">
            <input type="text" id="searchBar" class="search-bar" placeholder="Search for a place..." onkeyup="filterCards()">
            <button id="startVoiceButton" onclick="startVoiceSearch()">ðŸŽ¤</button>
             <!-- Filter Dropdowns for City, State, and Country -->
    <select id="cityFilter" onchange="filterCards()">
        <option value="">All Cities</option>
        {% for city in cities %}
        <option value="{{ city }}">{{ city }}</option>
        {% endfor %}
    </select>
    <select id="stateFilter" onchange="filterCards()">
        <option value="">All States</option>
        {% for state in states %}
        <option value="{{ state }}">{{ state }}</option>
        {% endfor %}
    </select>
    <select id="countryFilter" onchange="filterCards()">
        <option value="">All Countries</option>
        {% for country in countries %}
        <option value="{{ country }}">{{ country }}</option>
        {% endfor %}
    </select>

    </div>

    <div id="voiceModal" class="modal">
        <div class="modal-content">
            <p>Please speak now...</p>
            <button id="closeModal" class="close-btn">Close</button>
        </div>
    </div>

    <div class="card-container">
        {% for place in places %}
        <div class="card" onclick="window.location.href='{% url 'get_place' place.id %}'">
            data-city="{{ place.city }}"
            data-state="{{ place.state }}"
            data-country="{{ place.country }}">
            <img src="{{place.front_image.url}}" alt="{{ place.name }}">
            <h2>{{ place.name }}</h2>
        </div>
        {% endfor %}
    </div>
    </div>

    <div id="placeDetailsModal" class="modal">
    <div class="modal-content">
        <h2 id="placeName"></h2>
        <img id="placeImage" alt="Place Image" style="width: 100%; height: 150px; object-fit: cover;">
        <p id="placeLocation"></p>
        <p id="placeDescription"></p>
        <button class="close-btn" onclick="closePlaceDetailsModal()">Close</button>
    </div>
    </div>
{% endblock %}


{% comment %} JAVASCRIPT {% endcomment %}
{% block javascript %}
<script>
    function filterCards() {
        const searchValue = document.getElementById('searchBar').value.toLowerCase();
        const cityValue = document.getElementById('cityFilter').value.toLowerCase();
        const stateValue = document.getElementById('stateFilter').value.toLowerCase();
        const countryValue = document.getElementById('countryFilter').value.toLowerCase();
        const cards = document.querySelectorAll('.card');
        cards.forEach(card => {
            const titleElement = card.querySelector('h2');
            const descriptionElement = card.querySelector('p');
            const cityElement = card.getAttribute('data-city') || '';
        const stateElement = card.getAttribute('data-state') || '';
        const countryElement = card.getAttribute('data-country') || '';
            const cardContent = 
                (titleElement ? titleElement.textContent.toLowerCase() : '') +
                ' ' +
                (descriptionElement ? descriptionElement.textContent.toLowerCase() : '');
            card.style.display = cardContent.includes(searchValue) ? '' : 'none';
            const matchesCity = cityValue === '' || cityElement.toLowerCase() === cityValue;
        const matchesState = stateValue === '' || stateElement.toLowerCase() === stateValue;
        const matchesCountry = countryValue === '' || countryElement.toLowerCase() === countryValue;

        card.style.display = matchesSearch && matchesCity && matchesState && matchesCountry ? '' : 'none';
    });
}

    

    function startVoiceSearch() {
        const modal = document.getElementById('voiceModal');
        const closeBtn = document.getElementById('closeModal');
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        modal.style.display = 'flex';
        recognition.lang = 'en-US';
        recognition.start();
        recognition.onresult = function (event) {
            const transcript = event.results[0][0].transcript;
            document.getElementById('searchBar').value = transcript;
            filterCards();
            fetch('/search_voice/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: transcript }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log(`Voice input processed: ${data.query}`);
                } else {
                    console.error('Error:', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
            modal.style.display = 'none';
        };
        recognition.onerror = function (event) {
            console.error('Speech recognition error:', event.error);
            modal.style.display = 'none';
        };
        recognition.onspeechend = function () {
            recognition.stop();
        };
        closeBtn.onclick = function () {
            modal.style.display = 'none';
            recognition.abort();
        };
    }
    function openPlaceDetails(placeName, placeLocation, placeDescription, placeImage) {
        const modal = document.getElementById('placeDetailsModal');
        document.getElementById('placeName').textContent = placeName;
        document.getElementById('placeLocation').textContent = `Location: ${placeLocation}`;
        document.getElementById('placeDescription').textContent = placeDescription;
        document.getElementById('placeImage').src = placeImage;
        modal.style.display = 'flex';
    }
    function closePlaceDetailsModal() {
        document.getElementById('placeDetailsModal').style.display = 'none';
    }
</script>
{% endblock javascript %}
